<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClipForge - Login</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
</head>
<body class="animate-fadeIn">
    <div class="login-container animate-fadeInUp">
        <div class="login-content card-primary">
            <div class="login-header">
                <h1>🎬 ClipForge</h1>
                <p>Sign in with your Plex account to continue</p>
            </div>
            
            <div id="login-alert" class="alert alert-error" style="display: none;"></div>
            
            <div class="login-methods">
                <div class="login-method">
                    <div class="login-method-header">
                        <h3>Sign In with Plex</h3>
                        <p>Use your Plex.tv account credentials</p>
                    </div>
                    
                    <div class="login-button-container">
                        <button id="sign-in-plex" class="btn btn-primary btn-lg hover-lift" disabled>
                            <span class="btn-icon">🔑</span>
                            <span class="btn-text">Sign In with Plex</span>
                        </button>
                    </div>
                    
                    <div class="remember-me-container">
                        <label class="checkbox-label">
                            <input type="checkbox" id="remember_me_plex" checked>
                            <span class="checkmark"></span>
                            Remember me for 30 days
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/theme.js"></script>
    <script src="/static/js/auth.js"></script>
    <script>
        let isAuthenticating = false;

        function showAlert(message, isError = true) {
            const alert = document.getElementById('login-alert');
            alert.textContent = message;
            alert.className = `alert ${isError ? 'alert-error' : 'alert-success'}`;
            alert.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function setButtonLoading(loading) {
            const button = document.getElementById('sign-in-plex');
            const icon = button.querySelector('.btn-icon');
            const text = button.querySelector('.btn-text');
            
            if (loading) {
                button.disabled = true;
                button.classList.add('loading');
                icon.textContent = '⏳';
                text.textContent = 'Authenticating...';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                icon.textContent = '🔑';
                text.textContent = 'Sign In with Plex';
            }
        }

        function onOAuthSuccess(authToken) {
            
            const rememberMe = document.getElementById('remember_me_plex').checked;
            
            signInWithToken(authToken, rememberMe).then(result => {
                if (result.success) {
                    showAlert('Sign in successful! Redirecting...', false);
                    // Redirect to main page after successful login
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    showAlert(result.error || 'Authentication failed');
                    setButtonLoading(false);
                    isAuthenticating = false;
                }
            }).catch(error => {
                showAlert('Authentication failed');
                setButtonLoading(false);
                isAuthenticating = false;
            });
        }

        function onOAuthError(error) {
            showAlert(error || 'Authentication failed');
            setButtonLoading(false);
            isAuthenticating = false;
        }

        async function checkForMobileOAuthReturn() {
            // Check if returning from mobile OAuth redirect
            const isRedirect = sessionStorage.getItem('plex_auth_redirect');
            const pinId = sessionStorage.getItem('plex_auth_pin_id');
            
            if (isRedirect && pinId) {
                // Clear stored values
                sessionStorage.removeItem('plex_auth_redirect');
                sessionStorage.removeItem('plex_auth_pin_id');
                
                // Show loading state
                setButtonLoading(true);
                isAuthenticating = true;
                
                // Start polling for authentication completion
                const pollForAuth = async () => {
                    try {
                        const response = await fetch(`/api/v1/auth/pin/${pinId}`);
                        if (response.ok) {
                            const status = await response.json();
                            if (status && status.authenticated && status.auth_token) {
                                // Authentication successful
                                onOAuthSuccess(status.auth_token);
                                return;
                            }
                        }
                        
                        // Continue polling if not authenticated yet
                        setTimeout(pollForAuth, 1000);
                    } catch (error) {
                        onOAuthError('Failed to complete authentication');
                    }
                };
                
                // Start polling
                pollForAuth();
                
                // Set timeout for mobile auth (2 minutes)
                setTimeout(() => {
                    if (isAuthenticating) {
                        onOAuthError('Authentication timeout');
                    }
                }, 2 * 60 * 1000);
            }
        }

        // Initialize login page
        document.addEventListener('DOMContentLoaded', function() {
            const signInButton = document.getElementById('sign-in-plex');
            signInButton.disabled = false;
            
            // Check if returning from mobile OAuth redirect
            checkForMobileOAuthReturn();

            signInButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (isAuthenticating) return;
                
                isAuthenticating = true;
                setButtonLoading(true);
                
                // Hide any previous alerts
                document.getElementById('login-alert').style.display = 'none';
                
                // Start Plex OAuth flow
                plexOAuth(onOAuthSuccess, onOAuthError);
            });

            // Handle page visibility change to close popup if user navigates away
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && isAuthenticating) {
                    closePlexOAuthWindow();
                }
            });
        });

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (isAuthenticating) {
                closePlexOAuthWindow();
            }
        });
    </script>
</body>
</html>